import { readFile, readdir, stat, writeFile } from "node:fs/promises";
import {extname, join} from "node:path";
import {
  replaceBetween,
  VARIABLES_REPLACE_AFTER_TEST_COMMENT,
} from "./replace-between.js";
import {dirname} from "path";
import {mkdir} from "fs/promises";

const PACKAGE_GENERATED_PATH = "./esnext/package.readonly.ts";

{
  const {
    info,
    date
  } = await import("./git-info.js");

  const packageReadonlyContents = `
// File generated by scripts/git-info-build.js

export const commit = "${info.commit}";
export const commitShort = "${info.shortCommit}";
export const commitAuthor = "${info.author}";
export const commitEmail = "${info.email}";
export const commitMessage = "${info.message}";
export const commitAt = "${isNaN(date.getTime()) ? "" : date.toISOString()}";
${VARIABLES_REPLACE_AFTER_TEST_COMMENT}
export const secondsBetweenCommitAndTestCompletion = "";
export const minutesBetweenCommitAndTestCompletion = "";
export const timeBetweenCommitAndTestCompletion = "";
    `.trim();

  await mkdir(dirname(PACKAGE_GENERATED_PATH), {
    recursive: true
  })
  await writeFile(PACKAGE_GENERATED_PATH, packageReadonlyContents, "utf-8");
}
